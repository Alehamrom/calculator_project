# Распределенный вычислитель арифметических выражений

Система позволяет пользователям отправлять арифметические выражения через REST API, которые затем парсятся, разбиваются на задачи и вычисляются асинхронно агентами-воркерами через gRPC. Оркестратор управляет процессом вычисления, обрабатывает зависимости задач и сохраняет результаты в базе данных SQLite с поддержкой многопользовательского режима и авторизации по JWT.

## Ключевые возможности

-   **Распределенная архитектура:** Проект состоит из сервиса-Оркестратора и одного или нескольких Агентов-воркеров.
-   **REST API:** Взаимодействие пользователя с системой происходит через HTTP API Оркестратора (регистрация, вход, отправка выражений, просмотр результатов).
-   **gRPC взаимодействие:** Общение между Оркестратором и Агентами для распределения задач и отправки результатов реализовано с использованием gRPC.
-   **Асинхронные вычисления:** Выражения парсятся в графы задач, которые асинхронно выполняются доступными Агентами.
-   **Управление задачами:** Оркестратор управляет зависимостями задач в графе выражения.
-   **Многопользовательский режим:** Поддержка регистрации и авторизации пользователей с изоляцией данных.
-   **JWT Аутентификация и Авторизация:** Использование JWT токенов для защиты API эндпоинтов.
-   **Хранение данных:** Все данные (пользователи, выражения, задачи) сохраняются в базе данных SQLite.
-   **Поддерживаемые операции:** Базовые арифметические операции (+, -, *, /) и группировка с помощью скобок ().
-   **Конфигурируемость:** Время выполнения операций и вычислительная мощность агентов настраиваются через переменные окружения.
-   **Docker Compose:** Простая сборка и запуск всех компонентов проекта с помощью Docker Compose.

## Требования

Для сборки и запуска проекта необходимы:

-   Установленный Go (рекомендуется версия 1.22 или выше).
-   Установленный Docker.
-   Установленный Docker Compose (входит в состав Docker Desktop).

## Архитектура

Проект имеет распределенную архитектуру и состоит из двух основных компонентов:

1.  **Оркестратор (Orchestrator):**
    * Ядро системы.
    * Принимает HTTP-запросы от пользователей (регистрация, логин, отправка выражений, просмотр результатов).
    * Парсит арифметические выражения, строит дерево/граф задач.
    * Управляет состоянием выражений и задач в базе данных.
    * Предоставляет gRPC-сервер для взаимодействия с Агентами.
    * Распределяет готовые к выполнению задачи между доступными Агентами.
    * Принимает результаты вычислений от Агентов и обновляет состояние задач и выражений.

2.  **Агент (Agent):**
    * Воркер, выполняющий непосредственные вычисления.
    * Работает как gRPC-клиент, подключаясь к Оркестратору.
    * Запрашивает задачи у Оркестратора.
    * Выполняет полученные арифметические операции.
    * Отправляет результаты вычислений обратно Оркестратору.
    * Может быть запущено несколько экземпляров Агента для параллельного выполнения задач.

### Взаимодействие компонентов

Взаимодействие между компонентами происходит следующим образом:

1.  Пользователь взаимодействует с **Оркестратором** через **REST API (HTTP)**.
2.  **Оркестратор** и **Агенты** взаимодействуют друг с другом через **gRPC** (Агент как клиент, Оркестратор как сервер).
3.  **Оркестратор** работает с базой данных **SQLite** для хранения пользователей, выражений и задач.


### Схема работы

```mermaid
graph TD
    subgraph "Внешний Клиент"
        User[Пользователь]
    end

    subgraph "Сервис Оркестратора"
        Orchestrator["Оркестратор<br/>(HTTP & gRPC Server)"]
        Database[(База данных<br/>SQLite)]
    end

    subgraph "Сервис(ы) Агента"
        Agent["Агент<br/>(gRPC Client)"]
    end

    User -- HTTP API<br/>(Порт 8080) --> Orchestrator
    Orchestrator -- Управление данными --> Database
    Orchestrator -- gRPC Поток<br/>(Задачи/Результаты<br/>Порт 50051) <--> Agent

## Установка и Настройка

Для запуска проекта необходимо выполнить следующие шаги:

1.  **Клонирование репозитория:**

    Откройте терминал и выполните команду:

    ```bash
    git clone https://github.com/Alehamrom/calculator_project
    ```

    Перейдите в директорию проекта:

    ```bash
    cd calculator_project
    ```

2.  **Загрузка зависимостей:**

    Загрузите необходимые Go модули:

    ```bash
    go mod download
    # или
    # go mod tidy
    ```

3.  **Настройка переменных окружения:**

    Проект использует переменные окружения для конфигурации (например, адреса портов, секретный ключ JWT, время операций). Рекомендуется создать файл **`.env`** в корневой директории проекта и определить переменные там.

    Перед запуском создайте файл .env в корне проекта. Он должен содержать такие данные как:

    ```dotenv
    # .env файл в корневой директории проекта

    # Адреса для Оркестратора
    HTTP_LISTEN_ADDR=:8080
    GRPC_LISTEN_ADDR=:50051

    # Секретный ключ для JWT токенов
    JWT_SECRET=ваш_секретный_ключ

    # Путь к файлу базы данных SQLite
    DATABASE_FILE=/app/data/calculator.db # Этот путь используется внутри Docker контейнера

    # Время выполнения операций в миллисекундах
    TIME_ADDITION_MS=100
    TIME_SUBTRACTION_MS=100
    TIME_MULTIPLICATION_MS=100
    TIME_DIVISION_MS=100

    # Адрес Оркестратора для Агента (используется внутри Docker сети)
    ORCHESTRATOR_GRPC_ADDRESS=orchestrator:50051

    # ID Агента (можно использовать переменную окружения HOSTNAME)
    AGENT_ID=agent-${HOSTNAME}
    ```



## Запуск проекта

Самый простой и рекомендуемый способ запустить все компоненты проекта (Оркестратор и Агент) — это использовать Docker Compose.

1.  Убедитесь, что у вас установлен Docker Desktop и доступна команда `docker compose` или `docker-compose`.
2.  Перейдите в корневую директорию проекта, где находятся файлы `docker-compose.yml`, `Dockerfile`, `Dockerfile.agent`, и созданный вами файл `.env`.
3.  Выполните команду для сборки образов и запуска контейнеров:

    ```bash
    docker-compose up --build
    # Или, если docker-compose не найден, попробуйте:
    # docker compose up --build
    ```
    Опция `--build` соберет образы, если они еще не существуют или были изменены. При наличии файла `.env` в той же директории, Docker Compose автоматически прочитает из него переменные окружения.

4.  Сервисы Оркестратора и Агента будут запущены, и их логи будут отображаться в вашем терминале. Оркестратор будет доступен по адресу `localhost:8080` (HTTP API) и `localhost:50051` (gRPC для Агентов). Агенты будут автоматически подключаться к Оркестратору внутри сети Docker.
5.  Чтобы остановить все запущенные контейнеры, нажмите `Ctrl+C` в терминале, где запущена команда `docker-compose up`, или выполните в другом терминале в той же директории:

    ```bash
    docker-compose down
    # Или
    # docker compose down
    ```

6.  Данные базы данных SQLite будут сохраняться в Docker томе `calculator_project_orchestrator_data`, поэтому они сохранятся между перезапусками контейнеров.

---

## REST API

Взаимодействие с Оркестратором происходит через REST API. При запуске через Docker Compose, API доступно на вашей хост-машине по адресу `http://localhost:8080/api/v1`.

**Важно:** Все эндпоинты, кроме `/register` и `/login`, требуют **JWT** токен в заголовке `Authorization: Bearer <ваш_токен>`.

### Эндпоинты API

| Метод    | URL                        | Требует аутентификации? | Описание                                            |
| -------- | -------------------------- | ----------------------- | --------------------------------------------------- |
| **POST** | `/api/v1/register`         | ❌ Нет                  | Регистрация нового пользователя.                    |
| **POST** | `/api/v1/login`            | ❌ Нет                  | Вход пользователя, получение JWT токена.            |
| **POST** | `/api/v1/calculate`        | ✅ Да                   | Отправить арифметическое выражение на вычисление.   |
| **GET** | `/api/v1/expressions`      | ✅ Да                   | Получить список всех ваших выражений.               |
| **GET** | `/api/v1/expressions/{id}` | ✅ Да                   | Получить детали конкретного выражения по его ID.    |

---

## Примеры использования API

Ниже приведены примеры HTTP-запросов с использованием утилит командной строки (`curl` для Linux/Bash и `Invoke-RestMethod` или `curl` для Windows PowerShell).

### 1. Регистрация пользователя

**(Bash):**
```bash
curl -X POST http://localhost:8080/api/v1/register -H "Content-Type: application/json" -d '{"login": "myuser", "password": "mypassword"}'
```

### 2. Вход и получение JWT токена

**(Bash):**
```bash
curl -X POST http://localhost:8080/api/v1/login -H "Content-Type: application/json" -d '{"login": "myuser", "password": "mypassword"}'
```

### 3. Отправка выражения на вычисление (требует авторизации)

Замените `ВАШ_JWT_ТОКЕН` на токен, полученный на предыдущем шаге.

**(Bash):**
```bash
curl -X POST http://localhost:8080/api/v1/calculate -H "Content-Type: application/json" -H "Authorization: Bearer ВАШ_JWT_ТОКЕН" -d '{"expression": "2 + 2 * (3 + 4)"}'
```

### 4. Получение списка ваших выражений (требует авторизации)

Замените `ВАШ_JWT_ТОКЕН` на токен.

**(Bash):**
```bash
curl -X GET http://localhost:8080/api/v1/expressions -H "Authorization: Bearer ВАШ_JWT_ТОКЕН"
```

### 5. Получение деталей конкретного выражения по ID (требует авторизации)

Замените `ВАШ_JWT_ТОКЕН` на токен, а `ID_ВЫРАЖЕНИЯ` на UUID выражения.

**Linux (Bash):**
```bash
curl -X GET http://localhost:8080/api/v1/expressions/ID_ВЫРАЖЕНИЯ -H "Authorization: Bearer ВАШ_JWT_ТОКЕН"
```

## Запуск тестов

В проекте присутствуют юнит-тесты для основных пакетов.

Для запуска всех тестов в проекте используйте следующую команду в корневой директории проекта:

```bash
go test ./...
```

Эта команда найдет и выполнит все файлы тестов (*_test.go) во всех поддиректориях.

Чтобы получить информацию о покрытии кода тестами, выполните:

```Bash

go test -cover ./...
```
